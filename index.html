<!doctype html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>messenger test</title>

	<script type="text/javascript">
		(function(){
			window['CLARITY'] = [];
			var ns = document.createElement('script'), s = document.getElementsByTagName('script')[0];
			ns.async = true; ns.type = 'text/javascript'; ns.src = '//lib.spinmedia.com/clarity.min.js'; s.parentNode.insertBefore(ns, s);
		})();
	</script>	
</head>

<body>
	<div id="master">
		<fieldset>
			<legend>Websocket</legend>

			<div class="actions">
				<p><input type="text" name="room_name" data-input="join"/><button data-action="join">Join Channel</button></p>
				<p><input type="text" name="message" data-input="send"/><button data-action="send">Send Message</button></p>
			</div>

			<dl class="log">

			</dl><!-- /.log -->
		</fieldset>
	</div><!-- /#master -->

	<script type="text/html" id="message_template">
		<dt></dt>
		<dd>[!= dt.data !]</dd>
	</script>
</body>

	<script type="text/javascript">
		CLARITY.push({
			use: ['jquery', 'doubleunderscore'],
			run: function($, __){
				var template = __.template(document.getElementById('message_template').innerHTML);
				var socket = null;
				var $log = $('.log');

				$(document).on('click', '[data-action="join"]', function(e){
					e.preventDefault();

					var $button = $(this);
					var $input = $('[data-input="' + $button.data('action') + '"]');

					if (socket) {
						socket.close();
					};

					socket = new WebSocket('ws://localhost:12345/room/' + $input.val());

					socket.onmessage = function(event) {
						console.dir(event);
						$log.append(template({ data: event.data }));
					};
				});

				$(document).on('click', '[data-action="send"]', function(e){
					e.preventDefault();

					var $button = $(this);
					var $input = $('[data-input="' + $button.data('action') + '"]');

					if (socket) {
						socket.send($input.val());
					}
				});
			}
		});
	</script>
</html>
