<!doctype html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>messenger test</title>

	<script type="text/javascript">
		(function(){
			window['CLARITY'] = [];
			var ns = document.createElement('script'), s = document.getElementsByTagName('script')[0];
			ns.async = true; ns.type = 'text/javascript'; ns.src = '//lib.spinmedia.com/clarity.min.js'; s.parentNode.insertBefore(ns, s);
		})();
	</script>	
</head>

<body>
	<div id="master">
		<fieldset>
			<legend>Websocket Connections</legend>
			<p>
				Room Name <input type="text" data-input="room_name" value="abc"/>
				User Name <input type="text" data-input="user_name" value="bananas"/>
				<button data-action="connect">Connect Websockets</button>
				<button data-action="disconnect">Disconnect Websockets</button>
				<button data-action="message">Send Message</button>
			</p>

			<dl id="log">

			</dl><!-- /#log -->
		</fieldset>
	</div><!-- /#master -->
</body>

	<script type="text/javascript">
		CLARITY.push({
			use: ['jquery', 'doubleunderscore'],
			run: function($, __){
				var MessengerClient = function MessengerClient (params) {
					var self = this;

					var defaults = {
						url: '',
						params: {},
						reconnect: true,
						retry_delay: 5000,
						retry_attempts: 20
					};

					__.extend(self.options = {}, defaults, params);

					self.socket = null;
					self.fatal = false;
					self.attempts = 0;
					self.timer = null;
					self.state = 'closed';
				};

				__.augment(MessengerClient, __.PubSubPattern);
				MessengerClient.global_name = 'messenger_client';

				MessengerClient.prototype.open = function open () {
					var self = this;

					if (self.state === 'open') {
						return;
					};

					if (self.timer) {
						clearTimeout(self.timer);
					};

					if (!(self.socket instanceof WebSocket)) {
						self.socket = new WebSocket(__.sprintf("%s%s", self.options.url, __.toQueryParams(self.options.params)));
					};

					self.socket.onopen = function(e){
						self.state = 'open';
						self.fatal = false;
						self.attempts = 0;

						self.fire('open', e);
					};

					self.socket.onclose = function(e){
						self.state = 'closed';
						self.fire('close', e);
						self.socket = null;

						if (self.options.reconnect && !self.fatal) {
							if (self.attempts >= self.options.retry_attempts) {
								return;
							};

							if (!self.timer) {
								self.attempts++;
								self.timer = setTimeout(function(){ self.timer = null; self.open(); }, self.options.retry_delay);
							};
						};
					};

					self.socket.onerror = function(e){
						self.state = 'closed';
						self.fire('error', e);
					};

					self.socket.onmessage = function(e){
						self.fire('message', e);
					
						var data = null;

						try {
							var data = JSON.parse(e.data);
						} catch (e) {
							return;
						};

						if (data) {
							switch (data.messagetype) {
							case 'status':
								self.fire('status', data.status);
							break;

							case 'text':
								self.fire('text', data.text, data.user);
							break;

							};
						};
					};
				};
				
				MessengerClient.prototype.close = function close (fatal) {
					var self = this;

					if (fatal) {
						self.fatal = fatal;
					};

					self.socket.close(1000, 'connection reset by peer.');
				};

				MessengerClient.prototype.send = function send (message) {
					var self = this;

					self.socket.send(message);
					self.fire('send', message);
				};


				var log = document.getElementById('log');
				var $room_name = $('[data-input="room_name"]');
				var $user_name = $('[data-input="user_name"]');
				var clients = [];

				$(document).on('click', '[data-action="connect"]', function(e){
					e.preventDefault();

					connect();	
				});

				$(document).on('click', '[data-action="disconnect"]', function(e){
					e.preventDefault();

					disconnect();	
				});

				$(document).on('click', '[data-action="message"]', function(e){
					e.preventDefault();

					var random_client = __.getRandomItem(clients);
					random_client.send('testing message');
				});

		
				function connect () {
					var counter = 0, limit = 1;

					while (counter < limit) {
						var mc = new MessengerClient({
							url: 'ws://sb-129.net:12345/room',
							params: {
								name: $room_name.val() || 'blank',
								user_name: $user_name.val() || 'bananas'
							},
							reconnect: false
						});

						mc.on('message', function(message){
							log.innerHTML = log.innerHTML + __.sprintf('<p>%s</p>', message.data);
						});

						mc.open();
	
						clients.push(mc);
						counter++;
					};

					log.innerHTML = log.innerHTML + __.sprintf('<p><em>%s</em></p>', clients.length);
				};

				function disconnect () {
					var counter = clients.length;
					while (counter--) {
						clients[counter].close(true);
					};

					clients = [];
				};
			}
		});
	</script>
</html>
